{"version":3,"sources":["../../../../../src/webgpu/api/validation/render_pipeline/fragment_state.spec.ts"],"names":["description","makeTestGroup","assert","range","kTextureFormats","kRenderableColorTextureFormats","kTextureFormatInfo","kBlendFactors","kBlendOperations","getFragmentShaderCodeWithOutput","getPlainTypeInfo","kDefaultFragmentShaderCode","kTexelRepresentationInfo","CreateRenderPipelineValidationTest","g","values","test","desc","params","u","combine","fn","t","isAsync","goodDescriptor","getDescriptor","targets","format","doCreateRenderPipelineTest","badDescriptor","targetsLength","descriptor","i","writeMask","fragmentShaderCode","device","limits","maxColorAttachments","beforeAllSubcases","info","selectDeviceOrSkipTestCase","feature","renderable","color","beginSubcases","hasBlend","blend","alpha","undefined","sampleType","component","srcFactor","dstFactor","operation","defaultBlendComponent","blendComponentToTest","_success","filter","p","hasShaderOutput","componentCount","depthStencil","plainType","sampleTypeSuccess","componentOrder","length","combineWithParams","colorSrcFactor","colorDstFactor","alphaSrcFactor","alphaDstFactor","colorBlendReadsSrcAlpha","includes","meetsExtraBlendingRequirement"],"mappings":"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","sourcesContent":["export const description = `\nThis test dedicatedly tests validation of GPUFragmentState of createRenderPipeline.\n`;\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { assert, range } from '../../../../common/util/util.js';\nimport {\n  kTextureFormats,\n  kRenderableColorTextureFormats,\n  kTextureFormatInfo,\n  kBlendFactors,\n  kBlendOperations,\n} from '../../../capability_info.js';\nimport {\n  getFragmentShaderCodeWithOutput,\n  getPlainTypeInfo,\n  kDefaultFragmentShaderCode,\n} from '../../../util/shader.js';\nimport { kTexelRepresentationInfo } from '../../../util/texture/texel_data.js';\n\nimport { CreateRenderPipelineValidationTest } from './common.js';\n\nexport const g = makeTestGroup(CreateRenderPipelineValidationTest);\n\nconst values = [0, 1, 0, 1];\n\ng.test('color_target_exists')\n  .desc(`Tests creating a complete render pipeline requires at least one color target state.`)\n  .params(u => u.combine('isAsync', [false, true]))\n  .fn(async t => {\n    const { isAsync } = t.params;\n\n    const goodDescriptor = t.getDescriptor({\n      targets: [{ format: 'rgba8unorm' }],\n    });\n\n    // Control case\n    t.doCreateRenderPipelineTest(isAsync, true, goodDescriptor);\n\n    // Fail because lack of color states\n    const badDescriptor = t.getDescriptor({\n      targets: [],\n    });\n\n    t.doCreateRenderPipelineTest(isAsync, false, badDescriptor);\n  });\n\ng.test('max_color_attachments_limit')\n  .desc(\n    `Tests that color state targets length must not be larger than device.limits.maxColorAttachments.`\n  )\n  .params(u => u.combine('isAsync', [false, true]).combine('targetsLength', [8, 9]))\n  .fn(async t => {\n    const { isAsync, targetsLength } = t.params;\n\n    const descriptor = t.getDescriptor({\n      targets: range(targetsLength, i => {\n        // Set writeMask to 0 for attachments without fragment output\n        return { format: 'rgba8unorm', writeMask: i === 0 ? 0xf : 0 };\n      }),\n      fragmentShaderCode: kDefaultFragmentShaderCode,\n    });\n\n    t.doCreateRenderPipelineTest(\n      isAsync,\n      targetsLength <= t.device.limits.maxColorAttachments,\n      descriptor\n    );\n  });\n\ng.test('targets_format_renderable')\n  .desc(`Tests that color target state format must have RENDER_ATTACHMENT capability.`)\n  .params(u => u.combine('isAsync', [false, true]).combine('format', kTextureFormats))\n  .beforeAllSubcases(t => {\n    const { format } = t.params;\n    const info = kTextureFormatInfo[format];\n    t.selectDeviceOrSkipTestCase(info.feature);\n  })\n  .fn(async t => {\n    const { isAsync, format } = t.params;\n    const info = kTextureFormatInfo[format];\n\n    const descriptor = t.getDescriptor({ targets: [{ format }] });\n\n    t.doCreateRenderPipelineTest(isAsync, info.renderable && info.color, descriptor);\n  });\n\ng.test('targets_format_filterable')\n  .desc(`Tests that color target state format must be filterable if blend is not undefined.`)\n  .params(u =>\n    u\n      .combine('isAsync', [false, true])\n      .combine('format', kRenderableColorTextureFormats)\n      .beginSubcases()\n      .combine('hasBlend', [false, true])\n  )\n  .beforeAllSubcases(t => {\n    const { format } = t.params;\n    const info = kTextureFormatInfo[format];\n    t.selectDeviceOrSkipTestCase(info.feature);\n  })\n  .fn(async t => {\n    const { isAsync, format, hasBlend } = t.params;\n    const info = kTextureFormatInfo[format];\n\n    const descriptor = t.getDescriptor({\n      targets: [\n        {\n          format,\n          blend: hasBlend ? { color: {}, alpha: {} } : undefined,\n        },\n      ],\n    });\n\n    t.doCreateRenderPipelineTest(isAsync, !hasBlend || info.sampleType === 'float', descriptor);\n  });\n\ng.test('targets_blend')\n  .desc(\n    `\n  For the blend components on either GPUBlendState.color or GPUBlendState.alpha:\n  - Tests if the combination of 'srcFactor', 'dstFactor' and 'operation' is valid (if the blend\n    operation is \"min\" or \"max\", srcFactor and dstFactor must be \"one\").\n  `\n  )\n  .params(u =>\n    u\n      .combine('isAsync', [false, true])\n      .combine('component', ['color', 'alpha'] as const)\n      .beginSubcases()\n      .combine('srcFactor', kBlendFactors)\n      .combine('dstFactor', kBlendFactors)\n      .combine('operation', kBlendOperations)\n  )\n  .fn(async t => {\n    const { isAsync, component, srcFactor, dstFactor, operation } = t.params;\n\n    const defaultBlendComponent: GPUBlendComponent = {\n      srcFactor: 'src-alpha',\n      dstFactor: 'dst-alpha',\n      operation: 'add',\n    };\n    const blendComponentToTest: GPUBlendComponent = {\n      srcFactor,\n      dstFactor,\n      operation,\n    };\n    const format = 'rgba8unorm';\n\n    const descriptor = t.getDescriptor({\n      targets: [\n        {\n          format,\n          blend: {\n            color: component === 'color' ? blendComponentToTest : defaultBlendComponent,\n            alpha: component === 'alpha' ? blendComponentToTest : defaultBlendComponent,\n          },\n        },\n      ],\n    });\n\n    if (operation === 'min' || operation === 'max') {\n      const _success = srcFactor === 'one' && dstFactor === 'one';\n      t.doCreateRenderPipelineTest(isAsync, _success, descriptor);\n    } else {\n      t.doCreateRenderPipelineTest(isAsync, true, descriptor);\n    }\n  });\n\ng.test('targets_write_mask')\n  .desc(`Tests that color target state write mask must be < 16.`)\n  .params(u => u.combine('isAsync', [false, true]).combine('writeMask', [0, 0xf, 0x10, 0x80000001]))\n  .fn(async t => {\n    const { isAsync, writeMask } = t.params;\n\n    const descriptor = t.getDescriptor({\n      targets: [\n        {\n          format: 'rgba8unorm',\n          writeMask,\n        },\n      ],\n    });\n\n    t.doCreateRenderPipelineTest(isAsync, writeMask < 16, descriptor);\n  });\n\ng.test('pipeline_output_targets')\n  .desc(\n    `Pipeline fragment output types must be compatible with target color state format\n  - The scalar type (f32, i32, or u32) must match the sample type of the format.\n  - The componentCount of the fragment output (e.g. f32, vec2, vec3, vec4) must not have fewer\n    channels than that of the color attachment texture formats. Extra components are allowed and are discarded.\n\n  Otherwise, color state write mask must be 0.\n\n  MAINTENANCE_TODO: update this test after the WebGPU SPEC ISSUE 50 \"define what 'compatible' means\n  for render target formats\" is resolved.`\n  )\n  .params(u =>\n    u\n      .combine('isAsync', [false, true])\n      .combine('writeMask', [0, 0x1, 0x2, 0x4, 0x8, 0xf])\n      .combine('format', [undefined, ...kRenderableColorTextureFormats] as const)\n      .beginSubcases()\n      .combine('hasShaderOutput', [false, true])\n      .filter(p => p.format === undefined || p.hasShaderOutput === true)\n      .combine('sampleType', ['float', 'uint', 'sint'] as const)\n      .combine('componentCount', [1, 2, 3, 4])\n  )\n  .beforeAllSubcases(t => {\n    const { format } = t.params;\n    if (format) {\n      const info = kTextureFormatInfo[format];\n      t.selectDeviceOrSkipTestCase(info.feature);\n    }\n  })\n  .fn(async t => {\n    const { isAsync, writeMask, format, hasShaderOutput, sampleType, componentCount } = t.params;\n    const info = format ? kTextureFormatInfo[format] : null;\n\n    const descriptor = t.getDescriptor({\n      targets: format ? [{ format, writeMask }] : [],\n      // To have a dummy depthStencil attachment to avoid having no attachment at all which is invalid\n      depthStencil: { format: 'depth24plus' },\n      fragmentShaderCode: getFragmentShaderCodeWithOutput(\n        hasShaderOutput ? [{ values, plainType: getPlainTypeInfo(sampleType), componentCount }] : []\n      ),\n    });\n\n    let _success = true;\n    if (hasShaderOutput && info) {\n      // there is a target correspond to the pipeline output\n      assert(format !== undefined);\n      const sampleTypeSuccess =\n        info.sampleType === 'float' || info.sampleType === 'unfilterable-float'\n          ? sampleType === 'float'\n          : info.sampleType === sampleType;\n      _success =\n        sampleTypeSuccess &&\n        componentCount >= kTexelRepresentationInfo[format].componentOrder.length;\n    }\n\n    t.doCreateRenderPipelineTest(isAsync, _success, descriptor);\n  });\n\ng.test('pipeline_output_targets,blend')\n  .desc(\n    `On top of requirements from pipeline_output_targets, when blending is enabled and alpha channel is read indicated by any blend factor, an extra requirement is added:\n  - fragment output must be vec4.\n  `\n  )\n  .params(u =>\n    u\n      .combine('isAsync', [false, true])\n      .combine('format', ['r8unorm', 'rg8unorm', 'rgba8unorm', 'bgra8unorm'] as const)\n      .beginSubcases()\n      .combine('componentCount', [1, 2, 3, 4])\n      .combineWithParams([\n        // extra requirement does not apply\n        {\n          colorSrcFactor: 'one',\n          colorDstFactor: 'zero',\n          alphaSrcFactor: 'zero',\n          alphaDstFactor: 'zero',\n        },\n        {\n          colorSrcFactor: 'dst-alpha',\n          colorDstFactor: 'zero',\n          alphaSrcFactor: 'zero',\n          alphaDstFactor: 'zero',\n        },\n        // extra requirement applies, fragment output must be vec4 (contain alpha channel)\n        {\n          colorSrcFactor: 'src-alpha',\n          colorDstFactor: 'one',\n          alphaSrcFactor: 'zero',\n          alphaDstFactor: 'zero',\n        },\n        {\n          colorSrcFactor: 'one',\n          colorDstFactor: 'one-minus-src-alpha',\n          alphaSrcFactor: 'zero',\n          alphaDstFactor: 'zero',\n        },\n        {\n          colorSrcFactor: 'src-alpha-saturated',\n          colorDstFactor: 'one',\n          alphaSrcFactor: 'zero',\n          alphaDstFactor: 'zero',\n        },\n        {\n          colorSrcFactor: 'one',\n          colorDstFactor: 'zero',\n          alphaSrcFactor: 'one',\n          alphaDstFactor: 'zero',\n        },\n        {\n          colorSrcFactor: 'one',\n          colorDstFactor: 'zero',\n          alphaSrcFactor: 'zero',\n          alphaDstFactor: 'src',\n        },\n        {\n          colorSrcFactor: 'one',\n          colorDstFactor: 'zero',\n          alphaSrcFactor: 'zero',\n          alphaDstFactor: 'src-alpha',\n        },\n      ] as const)\n  )\n  .beforeAllSubcases(t => {\n    const { format } = t.params;\n    const info = kTextureFormatInfo[format];\n    t.selectDeviceOrSkipTestCase(info.feature);\n  })\n  .fn(async t => {\n    const sampleType = 'float';\n    const {\n      isAsync,\n      format,\n      componentCount,\n      colorSrcFactor,\n      colorDstFactor,\n      alphaSrcFactor,\n      alphaDstFactor,\n    } = t.params;\n    const info = kTextureFormatInfo[format];\n\n    const descriptor = t.getDescriptor({\n      targets: [\n        {\n          format,\n          blend: {\n            color: {\n              srcFactor: colorSrcFactor,\n              dstFactor: colorDstFactor,\n              operation: 'add',\n            },\n            alpha: {\n              srcFactor: alphaSrcFactor,\n              dstFactor: alphaDstFactor,\n              operation: 'add',\n            },\n          },\n        },\n      ],\n      fragmentShaderCode: getFragmentShaderCodeWithOutput([\n        { values, plainType: getPlainTypeInfo(sampleType), componentCount },\n      ]),\n    });\n\n    const colorBlendReadsSrcAlpha =\n      colorSrcFactor.includes('src-alpha') || colorDstFactor.includes('src-alpha');\n    const meetsExtraBlendingRequirement = !colorBlendReadsSrcAlpha || componentCount === 4;\n    const _success =\n      info.sampleType === sampleType &&\n      componentCount >= kTexelRepresentationInfo[format].componentOrder.length &&\n      meetsExtraBlendingRequirement;\n    t.doCreateRenderPipelineTest(isAsync, _success, descriptor);\n  });\n"],"file":"fragment_state.spec.js"}